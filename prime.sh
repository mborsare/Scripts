#!/bin/bash

# ======================================================
# ---- RECURSION GUARD ---------------------------------
if [[ -n "$AM_LOCK_UI" ]]; then
  UI_MODE=1
else
  export AM_LOCK_UI=1
  UI_MODE=0
fi

# ======================================================
# ---- STATE -------------------------------------------
DATE_FILE="$HOME/.rithmic_lock_date"
TODAY=$(date +%Y-%m-%d)

if [[ ! -f "$DATE_FILE" ]] || [[ "$(cat "$DATE_FILE")" != "$TODAY" ]]; then
  echo "$TODAY" > "$DATE_FILE"
fi

# ======================================================
# ---- OPEN TERMINAL (EXACTLY ONE WINDOW) --------------
if [[ "$UI_MODE" -eq 0 ]]; then
  /usr/bin/osascript <<'EOF'
tell application "Terminal"
  do script "AM_LOCK_UI=1 /bin/bash /Users/mikeb/Scripts/am-lock.sh"
  activate
end tell
EOF
  exit 0
fi

# ======================================================
# ---- 25 MINUTE COUNTDOWN -----------------------------
TOTAL_SECONDS=$((1 * 60))
END_TIME=$((SECONDS + TOTAL_SECONDS))

tput civis   # hide cursor

big_time() {
  local t="$1"
  local m=$((t / 60))
  local s=$((t % 60))
  printf "%02d:%02d" "$m" "$s"
}

draw_timer() {
  clear

  echo
  echo "
                               ▒██  ███                 
  ▒███▒          █             █░     █             █   
 ░█▒ ░█          █             █      █             █   
 █▒      ███   █████         █████    █    ░███░  █████ 
 █      ▓▓ ▒█    █             █      █    █▒ ▒█    █   
 █   ██ █   █    █             █      █        █    █   
 █    █ █████    █             █      █    ▒████    █   
 █▒   █ █        █             █      █    █▒  █    █   
 ▒█░ ░█ ▓▓  █    █░            █      █░   █░ ▓█    █░  
  ▒███▒  ███▒    ▒██           █      ▒██  ▒██▒█    ▒██ 
  "
  echo
  echo "
   ▄▄▄▄▀ █▄▄▄▄ ██   ██▄   ▄███▄       ▄█▄    ██   █    █▀▄▀█ 
▀▀▀ █    █  ▄▀ █ █  █  █  █▀   ▀      █▀ ▀▄  █ █  █    █ █ █ 
    █    █▀▀▌  █▄▄█ █   █ ██▄▄        █   ▀  █▄▄█ █    █ ▄ █ 
   █     █  █  █  █ █  █  █▄   ▄▀     █▄  ▄▀ █  █ ███▄ █   █ 
  ▀        █      █ ███▀  ▀███▀       ▀███▀     █     ▀   █  
          ▀      █                             █         ▀   
                ▀                             ▀              
  "
  echo
  echo "
  ▖▖              ▘    ▗ ▌                
▌▌▛▘▛▌█▌▛▌▛▘▌▌  ▌▛▘  ▜▘▛▌█▌  █▌▛▌█▌▛▛▌▌▌
▙▌▌ ▙▌▙▖▌▌▙▖▙▌  ▌▄▌  ▐▖▌▌▙▖  ▙▖▌▌▙▖▌▌▌▙▌
    ▄▌      ▄▌                        ▄▌
  "
  echo
  echo
    echo "
 ██▓███   ██▀███   ██▓ ███▄ ▄███▓▓█████ 
▓██░  ██▒▓██ ▒ ██▒▓██▒▓██▒▀█▀ ██▒▓█   ▀ 
▓██░ ██▓▒▓██ ░▄█ ▒▒██▒▓██    ▓██░▒███   
▒██▄█▓▒ ▒▒██▀▀█▄  ░██░▒██    ▒██ ▒▓█  ▄ 
▒██▒ ░  ░░██▓ ▒██▒░██░▒██▒   ░██▒░▒████▒
▒▓▒░ ░  ░░ ▒▓ ░▒▓░░▓  ░ ▒░   ░  ░░░ ▒░ ░
░▒ ░       ░▒ ░ ▒░ ▒ ░░  ░      ░ ░ ░  ░
░░         ░░   ░  ▒ ░░      ░      ░   
            ░      ░         ░      ░  ░
  "
  printf "           %s           " "$(big_time "$1")"
  tput sgr0
}

while (( SECONDS < END_TIME )); do
  remaining=$((END_TIME - SECONDS))
  draw_timer "$remaining"
  sleep 1
done

tput cnorm   # restore cursor
clear

# ======================================================
# ---- OUTPUT ------------------------------------------
echo "
░██                                       ░██             ░██    ░██                           
░██                                       ░██             ░██                                  
░████████  ░██░████  ░███████   ░██████   ░██    ░██   ░████████ ░██░█████████████   ░███████  
░██    ░██ ░███     ░██    ░██       ░██  ░██   ░██       ░██    ░██░██   ░██   ░██ ░██    ░██ 
░██    ░██ ░██      ░█████████  ░███████  ░███████        ░██    ░██░██   ░██   ░██ ░█████████ 
░███   ░██ ░██      ░██        ░██   ░██  ░██   ░██       ░██    ░██░██   ░██   ░██ ░██        
░██░█████  ░██       ░███████   ░█████░██ ░██    ░██       ░████ ░██░██   ░██   ░██  ░███████  
"
echo
echo
echo
echo

echo "
▗▄▄▖ ▗▄▄▄▖ ▗▄▄▖▗▄▄▄▖▗▄▄▖  ▗▄▖ ▗▄▄▄▖▗▖  ▗▖▗▄▄▄▖    ▗▄▄▖  ▗▄▖▗▖  ▗▖▗▄▄▖                  
▐▌ ▐▌▐▌   ▐▌     █  ▐▌ ▐▌▐▌ ▐▌  █  ▐▛▚▖▐▌  █      ▐▌ ▐▌▐▌ ▐▌▝▚▞▘▐▌                     
▐▛▀▚▖▐▛▀▀▘ ▝▀▚▖  █  ▐▛▀▚▖▐▛▀▜▌  █  ▐▌ ▝▜▌  █      ▐▛▀▘ ▐▛▀▜▌ ▐▌  ▝▀▚▖                  
▐▌ ▐▌▐▙▄▄▖▗▄▄▞▘  █  ▐▌ ▐▌▐▌ ▐▌▗▄█▄▖▐▌  ▐▌  █      ▐▌   ▐▌ ▐▌ ▐▌ ▗▄▄▞▘                  
                                                                                       
                                                                                       
                                                                                       
▗▄▄▄▖▗▖  ▗▖ ▗▄▖▗▄▄▄▖▗▄▄▄▖ ▗▄▖ ▗▖  ▗▖ ▗▄▄▖     ▗▄▖ ▗▄▄▖ ▗▄▄▄▖     ▗▄▄▖▗▄▄▄▖▗▄▖▗▄▄▄▖▗▄▄▄▖
▐▌   ▐▛▚▞▜▌▐▌ ▐▌ █    █  ▐▌ ▐▌▐▛▚▖▐▌▐▌       ▐▌ ▐▌▐▌ ▐▌▐▌       ▐▌     █ ▐▌ ▐▌ █  ▐▌   
▐▛▀▀▘▐▌  ▐▌▐▌ ▐▌ █    █  ▐▌ ▐▌▐▌ ▝▜▌ ▝▀▚▖    ▐▛▀▜▌▐▛▀▚▖▐▛▀▀▘     ▝▀▚▖  █ ▐▛▀▜▌ █  ▐▛▀▀▘
▐▙▄▄▖▐▌  ▐▌▝▚▄▞▘ █  ▗▄█▄▖▝▚▄▞▘▐▌  ▐▌▗▄▄▞▘    ▐▌ ▐▌▐▌ ▐▌▐▙▄▄▖    ▗▄▄▞▘  █ ▐▌ ▐▌ █  ▐▙▄▄▖
                                                                                       
                                                                                       
                                                                                       
 ▗▄▄▖ ▗▄▖ ▗▖  ▗▖▗▄▄▄▖     ▗▄▄▖ ▗▄▖ ▗▖  ▗▖▗▖  ▗▖ ▗▄▖  ▗▄▄▖                              
▐▌   ▐▌ ▐▌▐▛▚▞▜▌▐▌       ▐▌   ▐▌ ▐▌▐▛▚▖▐▌▐▌  ▐▌▐▌ ▐▌▐▌                                 
 ▝▀▚▖▐▛▀▜▌▐▌  ▐▌▐▛▀▀▘    ▐▌   ▐▛▀▜▌▐▌ ▝▜▌▐▌  ▐▌▐▛▀▜▌ ▝▀▚▖                              
▗▄▄▞▘▐▌ ▐▌▐▌  ▐▌▐▙▄▄▖    ▝▚▄▄▖▐▌ ▐▌▐▌  ▐▌ ▝▚▞▘ ▐▌ ▐▌▗▄▄▞▘                              
                                                                                       
                                                                                       
                                                                                       
 ▗▄▖ ▗▖   ▗▖ ▗▖ ▗▄▖▗▖  ▗▖▗▄▄▖     ▗▄▄▖▗▖  ▗▖▗▄▄▖▗▖   ▗▄▄▄▖▗▖  ▗▖ ▗▄▄▖                  
▐▌ ▐▌▐▌   ▐▌ ▐▌▐▌ ▐▌▝▚▞▘▐▌       ▐▌    ▝▚▞▘▐▌   ▐▌     █  ▐▛▚▖▐▌▐▌                     
▐▛▀▜▌▐▌   ▐▌ ▐▌▐▛▀▜▌ ▐▌  ▝▀▚▖    ▐▌     ▐▌ ▐▌   ▐▌     █  ▐▌ ▝▜▌▐▌▝▜▌                  
▐▌ ▐▌▐▙▄▄▖▐▙█▟▌▐▌ ▐▌ ▐▌ ▗▄▄▞▘    ▝▚▄▄▖  ▐▌ ▝▚▄▄▖▐▙▄▄▖▗▄█▄▖▐▌  ▐▌▝▚▄▞▘                  
                                                                                       
                                                                                       
                                                                                                         
"

echo "
States are chemical. They come and go.  You are all of them. Discipline is state control.
"
echo

# ======================================================
# ---- KILL MOTIVEWAVE ---------------------------------
pkill -f MotiveWave || true
echo "✔ MotiveWave stopped."
echo

# ======================================================
# ---- DNS BLOCK (AUTHORITATIVE) ------------------------
sudo mkdir -p /usr/local/etc/dnsmasq.d
echo "address=/rithmic.com/127.0.0.1" \
  | sudo tee /usr/local/etc/dnsmasq.d/block-rithmic.conf >/dev/null

sudo brew services restart dnsmasq >/dev/null 2>&1 || \
sudo brew services start dnsmasq >/dev/null 2>&1

sudo mkdir -p /etc/resolver
echo "nameserver 127.0.0.1" \
  | sudo tee /etc/resolver/rithmic.com >/dev/null

echo "✔ DNS block active (survives Wi-Fi toggles)."
echo
